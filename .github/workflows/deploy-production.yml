name: Deploy to Production

on:
  push:
    branches: [main]
    tags:
      - 'v*.*.*'  # ÊîØÊè¥ÁâàÊú¨Ê®ôÁ±§ÈÉ®ÁΩ≤
  workflow_dispatch:  # ÂÖÅË®±ÊâãÂãïËß∏Áôº
    inputs:
      confirm:
        description: 'Ëº∏ÂÖ• "DEPLOY" Á¢∫Ë™çÈÉ®ÁΩ≤Ëá≥ Production'
        required: true
        default: ''

env:
  AWS_REGION: ap-northeast-1
  EB_APPLICATION_NAME: fib-app
  EB_ENVIRONMENT_NAME: fib-app-production

jobs:
  # ÂÆâÂÖ®Ê™¢Êü•ÔºöÁ¢∫‰øù‰ΩøÁî®ËÄÖÁ¢∫Ë™ç
  verify-production-deploy:
    name: Verify Production Deployment
    runs-on: ubuntu-latest
    if: github.event_name == 'workflow_dispatch'
    steps:
      - name: Check confirmation
        run: |
          if [ "${{ github.event.inputs.confirm }}" != "DEPLOY" ]; then
            echo "‚ùå Deployment cancelled: confirmation required"
            exit 1
          fi
          echo "‚úÖ Production deployment confirmed"

  deploy:
    name: Deploy to AWS Elastic Beanstalk (Production)
    runs-on: ubuntu-latest
    needs: [verify-production-deploy]
    if: always() && (needs.verify-production-deploy.result == 'success' || github.event_name == 'push')
    timeout-minutes: 30

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Configure AWS credentials
        uses: aws-actions/configure-aws-credentials@v4
        with:
          aws-access-key-id: ${{ secrets.AWS_ACCESS_KEY_ID }}
          aws-secret-access-key: ${{ secrets.AWS_SECRET_ACCESS_KEY }}
          aws-region: ${{ env.AWS_REGION }}

      - name: Login to Amazon ECR
        id: login-ecr
        run: |
          aws ecr get-login-password --region ${{ env.AWS_REGION }} | \
          docker login --username AWS --password-stdin ${{ secrets.ECR_REGISTRY }}

      - name: Determine version tag
        id: version
        run: |
          if [[ "${{ github.ref }}" == refs/tags/* ]]; then
            VERSION=${GITHUB_REF#refs/tags/}
          else
            VERSION=${{ github.sha }}
          fi
          echo "version=$VERSION" >> $GITHUB_OUTPUT
          echo "Using version: $VERSION"

      - name: Build Docker images
        run: |
          echo "Building production images with version: ${{ steps.version.outputs.version }}"

          docker build -t ${{ secrets.ECR_REGISTRY }}/fib-fe:${{ steps.version.outputs.version }} \
            -t ${{ secrets.ECR_REGISTRY }}/fib-fe:latest \
            ./fib-fe

          docker build -t ${{ secrets.ECR_REGISTRY }}/fib-be:${{ steps.version.outputs.version }} \
            -t ${{ secrets.ECR_REGISTRY }}/fib-be:latest \
            ./fib-be

          docker build -t ${{ secrets.ECR_REGISTRY }}/fib-worker:${{ steps.version.outputs.version }} \
            -t ${{ secrets.ECR_REGISTRY }}/fib-worker:latest \
            ./fib-worker

          docker build -t ${{ secrets.ECR_REGISTRY }}/fib-nginx:${{ steps.version.outputs.version }} \
            -t ${{ secrets.ECR_REGISTRY }}/fib-nginx:latest \
            ./nginx

      - name: Push images to ECR
        run: |
          echo "Pushing production images to ECR..."

          docker push ${{ secrets.ECR_REGISTRY }}/fib-fe:${{ steps.version.outputs.version }}
          docker push ${{ secrets.ECR_REGISTRY }}/fib-fe:latest

          docker push ${{ secrets.ECR_REGISTRY }}/fib-be:${{ steps.version.outputs.version }}
          docker push ${{ secrets.ECR_REGISTRY }}/fib-be:latest

          docker push ${{ secrets.ECR_REGISTRY }}/fib-worker:${{ steps.version.outputs.version }}
          docker push ${{ secrets.ECR_REGISTRY }}/fib-worker:latest

          docker push ${{ secrets.ECR_REGISTRY }}/fib-nginx:${{ steps.version.outputs.version }}
          docker push ${{ secrets.ECR_REGISTRY }}/fib-nginx:latest

      - name: Generate Dockerrun.aws.json
        run: |
          envsubst < Dockerrun.aws.json.template > Dockerrun.aws.json
        env:
          ECR_REGISTRY: ${{ secrets.ECR_REGISTRY }}
          IMAGE_TAG: ${{ steps.version.outputs.version }}
          REDIS_HOST: ${{ secrets.PRODUCTION_REDIS_ENDPOINT }}
          PGHOST: ${{ secrets.PRODUCTION_RDS_ENDPOINT }}
          PGUSER: fib_prod
          PGDATABASE: fib_production
          PGPASSWORD: ${{ secrets.PRODUCTION_DB_PASSWORD }}

      - name: Create deployment package
        run: |
          zip -r deploy-${{ steps.version.outputs.version }}.zip Dockerrun.aws.json .ebextensions || true
          echo "Production deployment package created"

      - name: Upload to S3
        run: |
          aws s3 cp deploy-${{ steps.version.outputs.version }}.zip \
            s3://elasticbeanstalk-${{ env.AWS_REGION }}-${{ secrets.AWS_ACCOUNT_ID }}/fib-app/deploy-${{ steps.version.outputs.version }}.zip

      - name: Create application version
        run: |
          aws elasticbeanstalk create-application-version \
            --application-name ${{ env.EB_APPLICATION_NAME }} \
            --version-label production-${{ steps.version.outputs.version }} \
            --source-bundle S3Bucket="elasticbeanstalk-${{ env.AWS_REGION }}-${{ secrets.AWS_ACCOUNT_ID }}",S3Key="fib-app/deploy-${{ steps.version.outputs.version }}.zip" \
            --description "Production deploy: ${{ steps.version.outputs.version }}"

      - name: Deploy to Elastic Beanstalk
        run: |
          aws elasticbeanstalk update-environment \
            --application-name ${{ env.EB_APPLICATION_NAME }} \
            --environment-name ${{ env.EB_ENVIRONMENT_NAME }} \
            --version-label production-${{ steps.version.outputs.version }}

      - name: Wait for deployment
        run: |
          echo "Waiting for production environment to be ready..."
          aws elasticbeanstalk wait environment-updated \
            --application-name ${{ env.EB_APPLICATION_NAME }} \
            --environment-name ${{ env.EB_ENVIRONMENT_NAME }}

      - name: Verify health check
        run: |
          ENVIRONMENT_URL=$(aws elasticbeanstalk describe-environments \
            --application-name ${{ env.EB_APPLICATION_NAME }} \
            --environment-names ${{ env.EB_ENVIRONMENT_NAME }} \
            --query 'Environments[0].CNAME' \
            --output text)

          echo "Production URL: http://$ENVIRONMENT_URL"

          # Wait for health check endpoint
          sleep 30

          HEALTH_STATUS=$(curl -s -o /dev/null -w "%{http_code}" http://$ENVIRONMENT_URL/api/health || echo "000")

          if [ "$HEALTH_STATUS" = "200" ]; then
            echo "‚úÖ Production health check passed!"
            curl -s http://$ENVIRONMENT_URL/api/health | jq .
          else
            echo "‚ùå Production health check failed with status: $HEALTH_STATUS"
            echo "üîÑ Consider rolling back using: aws elasticbeanstalk update-environment --environment-name ${{ env.EB_ENVIRONMENT_NAME }} --version-label <previous-version>"
            exit 1
          fi

      - name: Deployment summary
        if: always()
        run: |
          echo "### üöÄ Production Deployment Summary" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "- **Environment**: Production" >> $GITHUB_STEP_SUMMARY
          echo "- **Region**: ${{ env.AWS_REGION }}" >> $GITHUB_STEP_SUMMARY
          echo "- **Version**: ${{ steps.version.outputs.version }}" >> $GITHUB_STEP_SUMMARY
          echo "- **Images**: ${{ secrets.ECR_REGISTRY }}/fib-*:${{ steps.version.outputs.version }}" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "‚ö†Ô∏è Monitor CloudWatch metrics for 10 minutes post-deployment" >> $GITHUB_STEP_SUMMARY

      - name: Notify deployment
        if: success()
        run: |
          echo "‚úÖ Production deployment completed successfully"
          echo "Version: ${{ steps.version.outputs.version }}"
