commands:
  01_install_asyncpg:
    command: "/var/app/venv/*/bin/pip install asyncpg"
    ignoreErrors: true
  02_create_db_user:
    command: |
      cat > /tmp/create_user.py << 'EOFPYTHON'
      import asyncio
      import asyncpg
      import ssl

      async def create_user():
          ssl_context = ssl.create_default_context()
          ssl_context.check_hostname = False
          ssl_context.verify_mode = ssl.CERT_NONE
          try:
              conn = await asyncpg.connect(
                  user="mac398",
                  password="Test12345678",
                  database="fib_staging",
                  host="fib-app-staging-db.c1qec0cgmaei.ap-northeast-1.rds.amazonaws.com",
                  port=5432,
                  ssl=ssl_context,
                  timeout=10
              )
              existing = await conn.fetchval("SELECT 1 FROM pg_roles WHERE rolname = 'fib_staging'")
              if existing:
                  await conn.execute("ALTER USER fib_staging WITH PASSWORD 'Test12345678'")
                  print("User fib_staging password updated")
              else:
                  await conn.execute("CREATE USER fib_staging WITH PASSWORD 'Test12345678'")
                  print("User fib_staging created")
              await conn.execute("GRANT ALL PRIVILEGES ON DATABASE fib_staging TO fib_staging")
              await conn.execute("GRANT USAGE, CREATE ON SCHEMA public TO fib_staging")
              await conn.execute("GRANT ALL PRIVILEGES ON ALL TABLES IN SCHEMA public TO fib_staging")
              await conn.execute("GRANT ALL PRIVILEGES ON ALL SEQUENCES IN SCHEMA public TO fib_staging")
              await conn.execute("ALTER DEFAULT PRIVILEGES IN SCHEMA public GRANT ALL PRIVILEGES ON TABLES TO fib_staging")
              await conn.execute("ALTER DEFAULT PRIVILEGES IN SCHEMA public GRANT ALL PRIVILEGES ON SEQUENCES TO fib_staging")
              await conn.close()
              print("User fib_staging ready!")
              return True
          except Exception as e:
              print(f"Error: {e}")
              return False

      asyncio.run(create_user())
      EOFPYTHON
      /var/app/venv/*/bin/python3 /tmp/create_user.py
    ignoreErrors: true
